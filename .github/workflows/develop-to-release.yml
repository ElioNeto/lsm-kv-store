name: Develop to Release

on:
  push:
    branches:
      - develop

defaults:
  run:
    shell: bash

concurrency:
  group: develop-to-release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  analyze-and-create-release-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version bump
        id: version
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Last tag: $LAST_TAG"

          LAST_VERSION=${LAST_TAG#v}

          IFS='.' read -ra VERSION_PARTS <<< "$LAST_VERSION"
          MAJOR=${VERSION_PARTS[0]:-0}
          MINOR=${VERSION_PARTS[1]:-0}
          PATCH=${VERSION_PARTS[2]:-0}

          COMMITS=$(git log "${LAST_TAG}..HEAD" --pretty=format:"%s" 2>/dev/null || git log --pretty=format:"%s")

          if echo "$COMMITS" | grep -qiE "^(BREAKING CHANGE|feat!|fix!):"; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
            BUMP_TYPE="major"
          elif echo "$COMMITS" | grep -qiE "^feat(\(.+\))?:"; then
            MINOR=$((MINOR + 1))
            PATCH=0
            BUMP_TYPE="minor"
          else
            PATCH=$((PATCH + 1))
            BUMP_TYPE="patch"
          fi

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "bump_type=$BUMP_TYPE" >> "$GITHUB_OUTPUT"
          echo "last_tag=$LAST_TAG" >> "$GITHUB_OUTPUT"
          echo "‚úÖ New version will be: v$NEW_VERSION (${BUMP_TYPE} bump)"

      - name: Create or update release branch
        env:
          NEW_VERSION: ${{ steps.version.outputs.new_version }}
        run: |
          RELEASE_BRANCH="release/v${NEW_VERSION}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git ls-remote --heads origin "$RELEASE_BRANCH" | grep -q "$RELEASE_BRANCH"; then
            echo "üìå Branch $RELEASE_BRANCH j√° existe, atualizando..."
            git fetch origin "$RELEASE_BRANCH"
            git checkout "$RELEASE_BRANCH"
            git merge origin/develop --no-edit
          else
            echo "üÜï Criando nova branch $RELEASE_BRANCH"
            git checkout -b "$RELEASE_BRANCH"
          fi

          git push origin "$RELEASE_BRANCH"
          echo "RELEASE_BRANCH=$RELEASE_BRANCH" >> "$GITHUB_ENV"

      - name: Check if PR exists
        id: check-pr
        env:
          GH_TOKEN: ${{ github.token }}
          NEW_VERSION: ${{ steps.version.outputs.new_version }}
        run: |
          RELEASE_BRANCH="release/v${NEW_VERSION}"

          PR_EXISTS=$(gh pr list --head "$RELEASE_BRANCH" --base main --json number --jq 'length')
          echo "pr_exists=$PR_EXISTS" >> "$GITHUB_OUTPUT"

          if [ "$PR_EXISTS" -gt 0 ]; then
            PR_NUMBER=$(gh pr list --head "$RELEASE_BRANCH" --base main --json number --jq '.[0].number')
            echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate changelog
        id: changelog
        env:
          LAST_TAG: ${{ steps.version.outputs.last_tag }}
        run: |
          if [ "$LAST_TAG" = "v0.0.0" ]; then
            CHANGELOG=$(git log --pretty=format:'- %s `%h`' | head -20)
          else
            CHANGELOG=$(git log "${LAST_TAG}..HEAD" --pretty=format:'- %s `%h`')
          fi

          echo "$CHANGELOG" > /tmp/changelog.txt

      - name: Create or update PR to main
        env:
          GH_TOKEN: ${{ github.token }}
          NEW_VERSION: ${{ steps.version.outputs.new_version }}
          BUMP_TYPE: ${{ steps.version.outputs.bump_type }}
        run: |
          RELEASE_BRANCH="release/v${NEW_VERSION}"
          CHANGELOG=$(cat /tmp/changelog.txt)

          if [ "${{ steps.check-pr.outputs.pr_exists }}" -eq 0 ]; then
            gh pr create \
              --base main \
              --head "$RELEASE_BRANCH" \
              --title "üöÄ Release v${NEW_VERSION}" \
              --body "## üöÄ Release v${NEW_VERSION}

          **Bump type:** \`${BUMP_TYPE}\`

          ---

          ### ‚öôÔ∏è Release Configuration
          **Escolha o tipo de release editando abaixo:**

          Release Type: [lts]

          **Op√ß√µes v√°lidas:**
          - \`alpha\` - Release alpha (inst√°vel, desenvolvimento)
          - \`beta\` - Release beta (pr√©-release, testes)
          - \`lts\` - Release est√°vel de longo prazo (produ√ß√£o)

          **üìù Instru√ß√µes:** Edite este PR e substitua \`lts\` acima por \`alpha\`, \`beta\` ou mantenha \`lts\`.

          ---

          ### üìù Changelog
          $CHANGELOG

          ---

          ### ‚úÖ Checklist antes do merge
          - [ ] Revisei as mudan√ßas
          - [ ] Defini o tipo de release correto
          - [ ] Testes passaram em develop
          - [ ] Documenta√ß√£o atualizada (se necess√°rio)

          ---

          _Este PR foi gerado automaticamente pelo workflow develop-to-release_" \
              --draft

            echo "‚úÖ PR criado: release/v${NEW_VERSION} ‚Üí main (draft)"
          else
            echo "‚ÑπÔ∏è PR j√° existe (#${{ steps.check-pr.outputs.pr_number }})"
            echo "Atualizando changelog..."

            CURRENT_BODY=$(gh pr view "${{ steps.check-pr.outputs.pr_number }}" --json body --jq .body)
            RELEASE_TYPE_LINE=$(echo "$CURRENT_BODY" | grep "Release Type:" || echo "Release Type: [lts]")

            gh pr edit "${{ steps.check-pr.outputs.pr_number }}" \
              --body "## üöÄ Release v${NEW_VERSION}

          **Bump type:** \`${BUMP_TYPE}\`

          ---

          ### ‚öôÔ∏è Release Configuration
          **Escolha o tipo de release editando abaixo:**

          $RELEASE_TYPE_LINE

          **Op√ß√µes v√°lidas:**
          - \`alpha\` - Release alpha (inst√°vel, desenvolvimento)
          - \`beta\` - Release beta (pr√©-release, testes)
          - \`lts\` - Release est√°vel de longo prazo (produ√ß√£o)

          ---

          ### üìù Changelog (atualizado)
          $CHANGELOG

          ---

          _√öltima atualiza√ß√£o: $(date +'%Y-%m-%d %H:%M:%S UTC')_"
          fi
